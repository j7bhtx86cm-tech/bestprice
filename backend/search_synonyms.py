"""
Russian Search Synonyms for BestPrice Catalog

Словарь синонимов для улучшения качества поиска.
Группы синонимов объединяют слова с одинаковым значением.

Использование:
- При поиске "курицы" также ищем "курица", "куриный", "куриное" и т.д.
- При поиске "говядины" также ищем "говядина", "говяжий", "говяжья" и т.д.
"""

from typing import List, Set, Dict
import re

# === SYNONYM GROUPS ===
# Каждая группа - это список слов/основ с одинаковым значением
# Первое слово - каноническое (для нормализации)

SYNONYM_GROUPS = [
    # Мясо птицы
    ['курица', 'курицы', 'куриц', 'куриный', 'куриное', 'куриная', 'куриного', 'куриной', 'курин', 'кур', 'цыплен', 'цыпленок', 'цыплят'],
    ['индейка', 'индейки', 'индеек', 'индюш', 'индюшин', 'индюшач', 'индюшат'],
    ['утка', 'утки', 'уток', 'утин', 'утиный', 'утиное', 'утиная'],
    ['гусь', 'гуся', 'гуси', 'гусин', 'гусиный', 'гусиное', 'гусиная'],
    
    # Красное мясо
    ['говядина', 'говядины', 'говяд', 'говяжий', 'говяжья', 'говяжье', 'говяжьего', 'говяж'],
    ['свинина', 'свинины', 'свинин', 'свиной', 'свиная', 'свиное', 'свиного', 'свин'],
    ['баранина', 'баранины', 'баранин', 'бараний', 'баранья', 'баранье', 'баран'],
    ['телятина', 'телятины', 'телятин', 'телячий', 'телячья', 'телячье', 'теленок', 'теленка'],
    
    # Рыба
    ['лосось', 'лосося', 'лососи', 'лосос', 'лососев', 'лососевый', 'лососевая', 'лососевое', 'семга', 'семги', 'сёмга', 'сёмги'],
    ['форель', 'форели', 'форел'],
    ['треска', 'трески', 'треск', 'тресков'],
    ['судак', 'судака', 'судаки', 'судач'],
    ['окунь', 'окуня', 'окуни', 'окун'],
    ['карп', 'карпа', 'карпы', 'карпов'],
    ['сельдь', 'сельди', 'селед', 'селёд', 'селедка', 'селёдка'],
    ['скумбрия', 'скумбрии', 'скумбр'],
    ['тунец', 'тунца', 'тунцы', 'тунцов'],
    
    # Морепродукты
    ['креветка', 'креветки', 'креветок', 'кревет'],
    ['кальмар', 'кальмара', 'кальмары', 'кальмаров'],
    ['мидия', 'мидии', 'мидий'],
    ['осьминог', 'осьминога', 'осьминоги', 'осьминогов'],
    ['краб', 'краба', 'крабы', 'крабов', 'крабов'],
    ['устрица', 'устрицы', 'устриц'],
    
    # Молочные продукты
    ['молоко', 'молока', 'молок', 'молочн', 'молочный', 'молочная', 'молочное'],
    ['сыр', 'сыра', 'сыры', 'сыров', 'сырн', 'сырный', 'сырная', 'сырное'],
    ['творог', 'творога', 'творож', 'творожн', 'творожный', 'творожная', 'творожное'],
    ['сметана', 'сметаны', 'сметан'],
    ['кефир', 'кефира', 'кефирн'],
    ['йогурт', 'йогурта', 'йогурты', 'йогуртов'],
    ['масло', 'масла', 'масел', 'маслян', 'масляный', 'масляная', 'масляное', 'сливочн'],
    
    # Овощи
    ['картофель', 'картофеля', 'картошка', 'картошки', 'картош', 'картоф'],
    ['морковь', 'моркови', 'морков', 'морковн', 'морковный', 'морковная', 'морковное'],
    ['лук', 'лука', 'луков', 'луковиц', 'репчат'],
    ['капуста', 'капусты', 'капуст'],
    ['помидор', 'помидора', 'помидоры', 'помидоров', 'томат', 'томата', 'томаты', 'томатов', 'томатн'],
    ['огурец', 'огурца', 'огурцы', 'огурцов', 'огурц'],
    ['перец', 'перца', 'перцы', 'перцев', 'перечн'],
    ['баклажан', 'баклажана', 'баклажаны', 'баклажанов'],
    ['кабачок', 'кабачка', 'кабачки', 'кабачков'],
    ['свекла', 'свеклы', 'свёкла', 'свёклы', 'свекол', 'свёкол'],
    ['чеснок', 'чеснока', 'чесноч', 'чесночн'],
    
    # Фрукты
    ['яблоко', 'яблока', 'яблоки', 'яблок', 'яблочн'],
    ['груша', 'груши', 'груш'],
    ['апельсин', 'апельсина', 'апельсины', 'апельсинов', 'апельсинов'],
    ['лимон', 'лимона', 'лимоны', 'лимонов', 'лимонн'],
    ['банан', 'банана', 'бананы', 'бананов'],
    ['виноград', 'винограда', 'виноградн'],
    ['клубника', 'клубники', 'клубнич', 'клубничн'],
    ['малина', 'малины', 'малинов', 'малиновый', 'малиновая', 'малиновое'],
    
    # Зерновые и крупы
    ['рис', 'риса', 'рисов', 'рисовый', 'рисовая', 'рисовое'],
    ['гречка', 'гречки', 'гречнев', 'гречневый', 'гречневая', 'гречневое', 'греч'],
    ['овес', 'овса', 'овсян', 'овсяный', 'овсяная', 'овсяное', 'овсянка', 'овсянки'],
    ['пшеница', 'пшеницы', 'пшеничн', 'пшеничный', 'пшеничная', 'пшеничное'],
    ['ячмень', 'ячменя', 'ячменн', 'ячменный', 'ячменная', 'ячменное', 'перловка', 'перловки', 'перлов'],
    
    # Типы обработки
    ['филе', 'филей', 'филейн', 'филейный', 'филейная', 'филейное'],
    ['фарш', 'фарша', 'фаршев', 'фаршевый', 'рублен', 'рубленый', 'рубленая', 'рубленое'],
    ['стейк', 'стейка', 'стейки', 'стейков'],
    ['котлета', 'котлеты', 'котлет'],
    ['колбаса', 'колбасы', 'колбас', 'колбасн', 'колбасный', 'колбасная', 'колбасное'],
    ['сосиска', 'сосиски', 'сосисок', 'сосисочн'],
    
    # Состояние
    ['замороженный', 'замороженная', 'замороженное', 'заморож', 'мороженый', 'мороженая', 'мороженое', 'морож', 'с/м', 'см'],
    ['охлажденный', 'охлажденная', 'охлажденное', 'охлажд', 'охл'],
    ['свежий', 'свежая', 'свежее', 'свеж'],
    ['копченый', 'копченая', 'копченое', 'копчен', 'копч', 'копчени', 'копчения'],  # копчени = стемм от "копчения"
    ['соленый', 'соленая', 'соленое', 'солен', 'засол', 'засолен', 'солени', 'соления'],  # солени = стемм от "соления"
    ['маринованный', 'маринованная', 'маринованное', 'маринован', 'маринад'],
    ['вяленый', 'вяленая', 'вяленое', 'вялен'],
    
    # Упаковка
    ['вакуум', 'вакуума', 'вакуумн', 'вакуумный', 'вакуумная', 'вакуумное', 'в/у'],
    ['банка', 'банки', 'банок', 'баноч', 'ж/б', 'жб', 'жестян'],
    ['бутылка', 'бутылки', 'бутылок'],
    ['пакет', 'пакета', 'пакеты', 'пакетов'],
    ['коробка', 'коробки', 'коробок', 'короб'],
]

# === BUILD LOOKUP STRUCTURES ===

# Словарь: слово → список синонимов (включая само слово)
_word_to_synonyms: Dict[str, List[str]] = {}

# Словарь: слово → каноническая форма (первое слово в группе)
_word_to_canonical: Dict[str, str] = {}

def _build_lookup():
    """Строит lookup структуры из SYNONYM_GROUPS"""
    global _word_to_synonyms, _word_to_canonical
    
    for group in SYNONYM_GROUPS:
        canonical = group[0]
        all_words = set(group)
        
        for word in group:
            word_lower = word.lower()
            _word_to_synonyms[word_lower] = list(all_words)
            _word_to_canonical[word_lower] = canonical

_build_lookup()


# === PUBLIC API ===

def get_synonyms(word: str) -> List[str]:
    """
    Возвращает список синонимов для слова.
    Если синонимы не найдены, возвращает [word].
    
    Пример:
        get_synonyms("курицы") → ["курица", "курицы", "куриц", "куриный", ...]
    """
    word_lower = word.lower()
    
    # Точное совпадение
    if word_lower in _word_to_synonyms:
        return _word_to_synonyms[word_lower]
    
    # Поиск по префиксу (для неполных слов)
    # Например: "кур" найдёт группу с "курица"
    for key, synonyms in _word_to_synonyms.items():
        if key.startswith(word_lower) and len(word_lower) >= 3:
            return synonyms
        if word_lower.startswith(key) and len(key) >= 3:
            return synonyms
    
    return [word]


def expand_query_with_synonyms(tokens: List[str]) -> List[str]:
    """
    Расширяет список токенов синонимами.
    
    Пример:
        expand_query_with_synonyms(["филе", "курицы"]) 
        → ["филе", "филей", "филейн", ..., "курица", "куриный", "куриное", ...]
    """
    expanded = set()
    
    for token in tokens:
        synonyms = get_synonyms(token)
        expanded.update(synonyms)
    
    return list(expanded)


def get_synonym_regex_parts(word: str, min_length: int = 3) -> List[str]:
    """
    Возвращает список regex-частей для поиска слова и его синонимов.
    Используется для построения $or условий в MongoDB.
    
    Пример:
        get_synonym_regex_parts("курицы") 
        → ["кур", "куриц", "курин", "цыплен", ...]  # укороченные основы для regex
    """
    synonyms = get_synonyms(word)
    
    # Берём уникальные короткие основы (3-5 символов) для эффективного regex
    bases = set()
    for syn in synonyms:
        # Основа - первые 3-5 символов
        if len(syn) >= min_length:
            bases.add(syn[:5] if len(syn) >= 5 else syn[:min_length])
    
    return list(bases)


def build_synonym_regex(tokens: List[str]) -> str:
    """
    Строит regex для поиска всех токенов с учётом синонимов.
    Использует lookahead assertions для поиска в любом порядке.
    
    ВАЖНО: Использует word boundaries чтобы избежать ложных совпадений
    (например "шкуре" не должно матчить "кур")
    
    Пример:
        build_synonym_regex(["филе", "курицы"])
        → "(?=.*\\b(филе|курин|курицы|куриц|цыплен))"
    """
    parts = []
    
    for token in tokens:
        synonyms = get_synonyms(token)
        
        # Берём полные синонимы (минимум 4 символа для точности)
        regex_alts = set()
        for syn in synonyms:
            # Минимум 4 символа чтобы избежать ложных срабатываний
            if len(syn) >= 4:
                regex_alts.add(re.escape(syn))
        
        # Добавляем оригинальный токен если он достаточно длинный
        if len(token) >= 3:
            regex_alts.add(re.escape(token))
        
        if regex_alts:
            # Создаём альтернативу с word boundary: \b(вариант1|вариант2|...)
            # \b в начале обеспечивает что мы ищем начало слова
            alt_pattern = '|'.join(sorted(regex_alts, key=len, reverse=True))
            parts.append(f'(?=.*\\b({alt_pattern}))')
    
    if parts:
        return ''.join(parts) + '.*'
    return '.*'


# === TESTS ===

def test_synonyms():
    """Тест синонимов"""
    print("=== Synonym Tests ===")
    
    test_cases = [
        ("курицы", ["курица", "куриный"]),
        ("говядины", ["говядина", "говяжий"]),
        ("лосось", ["лосось", "лососевый", "семга"]),
        ("филе", ["филе", "филейный"]),
        ("замороженный", ["замороженный", "мороженый"]),
    ]
    
    for word, expected_subset in test_cases:
        synonyms = get_synonyms(word)
        has_all = all(e in synonyms for e in expected_subset)
        status = "✅" if has_all else "❌"
        print(f"{status} {word}: {len(synonyms)} synonyms")
        if not has_all:
            print(f"   Missing: {[e for e in expected_subset if e not in synonyms]}")
    
    print()
    print("=== Regex Test ===")
    regex = build_synonym_regex(["филе", "курицы"])
    print(f"Regex for ['филе', 'курицы']:")
    print(f"  {regex[:100]}...")


if __name__ == '__main__':
    test_synonyms()
