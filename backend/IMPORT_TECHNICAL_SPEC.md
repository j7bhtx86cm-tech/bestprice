# –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø: –ò–º–ø–æ—Ä—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤ BestPrice

## –í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: 2026-01-07
## –ú–æ–¥—É–ª–∏: server.py, import_new_catalogs.py, unit_normalizer.py

---

# 1. –ö–û–ù–¢–†–ê–ö–¢ –ò–ú–ü–û–†–¢–ê –ò–ó –õ–ö (schema)

## 1.1 –°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫

### –û—Å–Ω–æ–≤–Ω–æ–π –∏–º–ø–æ—Ä—Ç (`/api/price-lists/import`)
**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∏ 852-900)

```python
# Mapping –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ JSON –≤ —Ñ–æ—Ä–º–µ column_mapping
mapping = {
    'productName': '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ñ–∞–π–ª–µ',  # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
    'price': '–¶–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞',                     # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
    'unit': '–ï–¥–∏–Ω–∏—Ü–∞ –∫–æ–ª–æ–Ω–∫–∞',                   # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
    'article': '–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∫–æ–ª–æ–Ω–∫–∞'              # –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û
}
```

| –ü–æ–ª–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------------|----------|--------|
| `productName` | ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ | "–ë–£–õ–ì–£–† 3 –∫–≥. –ê–≥—Ä–æ-–ê–ª—å—è–Ω—Å" |
| `price` | ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û | –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (float) | 452.25 |
| `unit` | ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û | –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è | "—à—Ç", "–∫–≥", "–ª" |
| `article` | ‚ùå –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û | –ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ | "93015159" |

### Batch Import (`import_new_catalogs.py`)
**–§–∞–π–ª:** `/app/backend/import_new_catalogs.py` (—Å—Ç—Ä–æ–∫–∏ 66-78)

| –ü–æ–ª–µ Excel | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------------|----------|
| `–ù–∞–∑–≤–∞–Ω–∏–µ` | ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ |
| `–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É` | ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û | –¶–µ–Ω–∞ (float > 0) |
| `–ï–¥–∏–Ω–∏—Ü–∞` | ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û | –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è |
| `–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞` | ‚ùå –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û | –ê—Ä—Ç–∏–∫—É–ª |
| `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–∏` | ‚ùå –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û | pack_qty (default: 1) |
| `–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑` | ‚ùå –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û | min_qty (default: 1) |

## 1.2 –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

### basis / base_unit
**–§–∞–π–ª:** `/app/backend/unit_normalizer.py` (—Å—Ç—Ä–æ–∫–∏ 11-15)

```python
class UnitType(str, Enum):
    WEIGHT = "WEIGHT"   # –∫–≥, –≥, kg, gr
    VOLUME = "VOLUME"   # –ª, –º–ª, l, ml
    PIECE = "PIECE"     # —à—Ç, pcs, —à—Ç—É–∫
    UNKNOWN = "UNKNOWN"
```

**–í supplier_items:**
- `base_unit`: "kg", "l", "pcs" (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ)
- `unit_supplier`: –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø—Ä–∞–π—Å–∞ ("—à—Ç", "–ª", "–∫–≥")
- `unit_norm`: "kg", "l", "pcs" (—Å–∏–Ω–æ–Ω–∏–º base_unit)

### ppu_unit
**–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ.** –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
- `price`: —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (unit_supplier)
- `price_per_base_unit`: —Ü–µ–Ω–∞ –∑–∞ –±–∞–∑–æ–≤—É—é –µ–¥–∏–Ω–∏—Ü—É (–∫–≥/–ª)

### offer_status, price_status
**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∞ 3146)

```python
# –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ:
{"active": True}  # –§–∏–ª—å—Ç—Ä –≤ supplier_items
```

**–°—Ç–∞—Ç—É—Å—ã –≤ pricelists:**
- `active: bool` ‚Äî –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–∞–π—Å
- `availability: bool` ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä

---

# 2. –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–§–§–ï–†–û–í

## 2.1 –ö–ª—é—á –¥–ª—è update vs create

### API Import (`/api/price-lists/import`)
**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∏ 880-896)

```python
# –í–°–ï–ì–î–ê CREATE (insert_one), –ù–ï–¢ –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–ò!
await db.price_lists.insert_one(price_dict)
```

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:** –¢–µ–∫—É—â–∏–π API —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ!

### Batch Import
**–§–∞–π–ª:** `/app/backend/import_new_catalogs.py` (—Å—Ç—Ä–æ–∫–∏ 81-84)

```python
# –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ products:
existing_product = db.products.find_one({
    'name': product_name,  # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á
    'unit': unit
})
```

**Pricelists:** –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ (–¥—É–±–ª–∏)

### supplier_items (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫)
**–§–∞–π–ª:** –ù–µ—Ç —è–≤–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ.

**–ö–ª—é—á –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:**
```
{
    "id": UUID,
    "supplier_item_code": "93015159",  // –∫–æ–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    "supplier_company_id": UUID,
    "name_raw": "–ë–£–õ–ì–£–† 3 –∫–≥..."
}
```

## 2.2 –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ

| –ö–æ–ª–ª–µ–∫—Ü–∏—è | –ü–æ–≤–µ–¥–µ–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-----------|-----------|-----------|
| `products` | Lookup by name+unit | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç |
| `pricelists` | –í–°–ï–ì–î–ê insert | **–î–£–ë–õ–ò!** |
| `price_lists` | –í–°–ï–ì–î–ê insert | **–î–£–ë–õ–ò!** |
| `supplier_items` | –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ | –î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—á–Ω—ã |

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** –ù–µ—Ç upsert –ª–æ–≥–∏–∫–∏, –Ω–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö!

---

# 3. –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´ –ü–û –ï–î–ò–ù–ò–¶–ê–ú –ò –¶–ï–ù–ï

## 3.1 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `/app/backend/unit_normalizer.py` (—Ñ—É–Ω–∫—Ü–∏—è `parse_pack_from_text`)

```
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –µ–¥–∏–Ω–∏—Ü:
1. –Ø–≤–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –≤ —Ç–µ–∫—Å—Ç–µ (–∫–≥, –≥, –ª, –º–ª, —à—Ç) ‚Äî HIGHEST
2. –ß–∏—Å–ª–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (~5–∫–≥, 300-400–≥)
3. –î—Ä–æ–±–∏ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã (4/5 –∫–≥, 0.5–ª)
4. Fallback –Ω–∞ unit_norm –∏–∑ –±–∞–∑—ã ‚Äî LOWEST
```

**–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:**
```python
# –í server.py —Å—Ç—Ä–æ–∫–∏ 3120-3121:
ref_pack_info = parse_pack_from_text(reference_name)  # –ò–∑ –Ω–∞–∑–≤–∞–Ω–∏—è!
# –ù–ï –∏–∑ unit_norm –∏–ª–∏ basis
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** `unit_raw` –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ "–ø–æ–±–µ–∂–¥–∞–µ—Ç" –Ω–∞–¥ `basis`/`unit_norm` –≤ –±–∞–∑–µ!

## 3.2 –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

**–§–∞–π–ª:** `/app/backend/unit_normalizer.py` (—Å—Ç—Ä–æ–∫–∏ 145-230)

### –ö–æ—Ä–æ–± ‚Üí —à—Ç—É–∫–∞
```python
# –ù–ï–¢ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏!
# –ö–æ—Ä–æ–± (–∫–æ—Ä–æ–±–∫–∞, —É–ø–∞–∫) –ø–∞—Ä—Å–∏—Ç—Å—è –∫–∞–∫ PIECE
(r'(\d+)\s*—É–ø', 1.0, UnitType.PIECE, 0.8)
```

### –∫–≥ ‚Üî —à—Ç—É–∫–∞
```python
# –í calculate_packs_needed (—Å—Ç—Ä–æ–∫–∏ 200-280):
# –ï—Å—Ç—å –±–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞, –Ω–æ –ù–ï–¢ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ø–æ –≤–µ—Å—É —É–ø–∞–∫–æ–≤–∫–∏

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å unit_type:
# WEIGHT ‚Üí WEIGHT: ‚úÖ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ base_qty
# WEIGHT ‚Üí PIECE: ‚ùå –ù–ï –°–û–í–ú–ï–°–¢–ò–ú–´
# PIECE ‚Üí PIECE: ‚úÖ –ø—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
```

### –ª ‚Üî –∫–≥
```python
# –ù–ï–¢ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏!
# VOLUME ‚Üí VOLUME: ‚úÖ
# VOLUME ‚Üí WEIGHT: ‚ùå –ù–ï –°–û–í–ú–ï–°–¢–ò–ú–´
```

**–¢–∞–±–ª–∏—Ü–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**

| Reference | Candidate | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
|-----------|-----------|---------------|
| WEIGHT | WEIGHT | ‚úÖ –î–∞ |
| WEIGHT | VOLUME | ‚ùå –ù–µ—Ç |
| WEIGHT | PIECE | ‚ùå –ù–µ—Ç |
| VOLUME | VOLUME | ‚úÖ –î–∞ |
| VOLUME | WEIGHT | ‚ùå –ù–µ—Ç |
| VOLUME | PIECE | ‚ùå –ù–µ—Ç |
| PIECE | PIECE | ‚úÖ –î–∞ |
| PIECE | WEIGHT | ‚ùå –ù–µ—Ç |
| PIECE | VOLUME | ‚ùå –ù–µ—Ç |

---

# 4. –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï PPU –ò MIN ORDER –í BESTPRICE

## 4.1 –¶–µ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∏ 3155-3160, 3640-3650)

```python
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `price` (—Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É), –ù–ï ppu!
candidate = {
    'price': si['price'],  # ‚Üê –≠–¢–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    # ppu –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ
}

# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ total_cost:
def sort_key(c):
    total_cost = c.get('_total_cost_mult', 0) or c['price']
    pack_penalty = c.get('_pack_score_penalty', 0)
    return (total_cost + pack_penalty * 10, -conf_boost)
```

**–§–æ—Ä–º—É–ª–∞ total_cost:**
```python
# –í unit_normalizer.py, calculate_packs_needed():
total_cost = price * packs_needed
```

## 4.2 –£—á—ë—Ç min_order_qty

**–¢–ï–ö–£–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:** `min_order_qty` **–ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è** –≤ BestPrice!

```python
# –í supplier_items –Ω–µ—Ç –ø–æ–ª—è min_order_qty
# –í pricelists –µ—Å—Ç—å minQuantity, –Ω–æ –æ–Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
```

**–ß—Ç–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è:**
```python
# –¢–æ–ª—å–∫–æ PACK_OUTLIER_THRESHOLD = 20
if packs_needed and packs_needed > PACK_OUTLIER_THRESHOLD:
    continue  # REJECT —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
```

## 4.3 –ï—Å–ª–∏ ppu –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/0

```python
# ppu –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –µ—Å–ª–∏ price = 0:
if price <= 0 or not product_name or product_name == 'nan':
    skipped += 1
    continue  # –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
```

**–í –ø–æ–∏—Å–∫–µ:** —Ç–æ–≤–∞—Ä—ã —Å `price=0` –±—É–¥—É—Ç –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ).

---

# 5. –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ü–†–ê–ô–°–û–í

## 5.1 –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–π—Å–æ–≤

**–û—Ç–≤–µ—Ç:** –î–ê, –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–π—Å–æ–≤!

**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∞ 3146)

```python
# –ó–∞–ø—Ä–æ—Å –∫ supplier_items:
supplier_items_cursor = db.supplier_items.find({"active": True}, {"_id": 0})
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
```
supplier_items: {
    "active": True,
    "price_list_id": "uuid",  // –ö –∫–∞–∫–æ–º—É –ø—Ä–∞–π—Å—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è
    "supplier_company_id": "uuid"
}
```

## 5.2 –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø—Ä–∞–π—Å–∞–º–∏

**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∏ 3144-3171)

```python
# –ë–µ—Ä—ë—Ç –í–°–ï active=True –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ pricelist!
# –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç–æ–≤–∞—Ä—ã –∏–∑ –í–°–ï–• –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–π—Å–æ–≤ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –ø–æ–∏—Å–∫–µ
```

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:** –ï—Å–ª–∏ –æ–¥–∏–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫ –∑–∞–≥—Ä—É–∑–∏–ª 2 –ø—Ä–∞–π—Å–∞:
- –û–±–∞ –±—É–¥—É—Ç –≤ –≤—ã–±–æ—Ä–∫–µ
- –ú–æ–≥—É—Ç –±—ã—Ç—å –¥—É–±–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
- –ü–æ–±–µ–¥–∏—Ç —Ç–æ–≤–∞—Ä —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤–µ—Ä—Å–∏–∏ –ø—Ä–∞–π—Å–∞)

## 5.3 –ö–∞–∫ "–≤—ã–∫–ª—é—á–∏—Ç—å" —Å—Ç–∞—Ä—ã–π –ø—Ä–∞–π—Å

**–í–∞—Ä–∏–∞–Ω—Ç 1:** –û–±–Ω–æ–≤–∏—Ç—å `active=False` –≤ supplier_items
```javascript
db.supplier_items.updateMany(
    {"price_list_id": "old-pricelist-uuid"},
    {"$set": {"active": false}}
)
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ pricelists
```javascript
db.pricelists.updateMany(
    {"id": "old-pricelist-uuid"},
    {"$set": {"active": false}}
)
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –≠—Ç–æ –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ supplier_items! –û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–ª–∞–≥ `active`.

---

# 6. –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –§–û–†–ú–ê–¢–ê –ó–ê–ì–†–£–ó–ö–ò

## 6.1 –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ñ–∞–π–ª—É

**–§–∞–π–ª:** `/app/backend/server.py` (—Å—Ç—Ä–æ–∫–∏ 836-841)

```python
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
if file.filename.endswith('.csv'):
    df = pd.read_csv(io.BytesIO(contents))
elif file.filename.endswith(('.xlsx', '.xls')):
    df = pd.read_excel(io.BytesIO(contents))
else:
    raise HTTPException(status_code=400, 
        detail="Only CSV and Excel files are supported")
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|----------|----------|----------|
| –§–æ—Ä–º–∞—Ç—ã | `.csv`, `.xlsx`, `.xls` | server.py:836-841 |
| –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ | –ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —è–≤–Ω–æ | FastAPI default |
| –ú–∞–∫—Å. —Å—Ç—Ä–æ–∫–∏ | –ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ | pandas default |
| –ö–æ–¥–∏—Ä–æ–≤–∫–∞ CSV | UTF-8 (default) | pandas default |

## 6.2 –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞

**–û—Ç–≤–µ—Ç:** –ù–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –Ω–∞–∑–≤–∞–Ω–∏—é –ª–∏—Å—Ç–∞!

```python
# pandas.read_excel() –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —á–∏—Ç–∞–µ—Ç –ü–ï–†–í–´–ô –ª–∏—Å—Ç
df = pd.read_excel(io.BytesIO(contents))
# sheet_name –Ω–µ —É–∫–∞–∑–∞–Ω = –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
```

**–î–ª—è batch import (`import_new_catalogs.py`):**
```python
df = pd.read_excel(file_path)
# –¢–∞–∫–∂–µ –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

---

# 7. –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò

## 7.1 UI/—ç–Ω–¥–ø–æ–π–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ù–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ endpoint –¥–ª—è active_pricelist_id!

**–î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:**

```
GET /api/debug/version
- build_sha, guards_categories
- –ù–ï–¢ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∞–π—Å–∞—Ö

GET /api/debug/validation  
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ supplier_items
- total_active_items
- –ù–ï–¢ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ pricelist
```

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–π—Å–µ

```bash
# MongoDB –∑–∞–ø—Ä–æ—Å:
db.supplier_items.countDocuments({"active": true})

# –ß–µ—Ä–µ–∑ API –Ω–µ—Ç ‚Äî –Ω—É–∂–µ–Ω –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ MongoDB
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Python:
```python
# –í rules_validator.py:
stats['total_active_items'] = db.supplier_items.count_documents({'active': True})
```

## 7.2 –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### API –æ—Ç–≤–µ—Ç—ã

**–£—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç:**
```json
{"message": "Successfully imported 1234 products"}
```

**–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞:**
```json
{
  "detail": "Error parsing file: [pandas error message]"
}
```

**–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Å—Ç—Ä–æ–∫–∏:**
```python
# –í import_new_catalogs.py —Å—Ç—Ä–æ–∫–∏ 118-121:
except Exception as e:
    print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ {idx}: {e}")
    skipped += 1
    continue
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `/var/log/supervisor/backend.out.log`

```
# –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —á–µ—Ä–µ–∑ batch:
üìÇ –ò–º–ø–æ—Ä—Ç: [SupplierName]
üìä –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: 1234
üìä –ö–æ–ª–æ–Ω–∫–∏: ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞', ...]
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–ø–æ—Ä—Ç–∞:
   –ü—Ä–æ–¥—É–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: 100
   –ü—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: 1234
   –ü—Ä–æ–ø—É—â–µ–Ω–æ —Å—Ç—Ä–æ–∫: 5
```

### –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª–∞ –æ—à–∏–±–æ–∫!
**‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é `import_logs` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–º–ø–æ—Ä—Ç–æ–≤.

---

# –†–ï–ó–Æ–ú–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –í–ª–∏—è–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---|----------|---------|--------------|
| 1 | –ù–µ—Ç upsert –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ | –î—É–±–ª–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ | –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á: supplier_id + article |
| 2 | min_order_qty –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è | –ù–µ—Ç–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ calculate_packs_needed |
| 3 | –ù–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–π—Å–æ–≤ | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è | –î–æ–±–∞–≤–∏—Ç—å price_list_version |
| 4 | –ù–µ—Ç –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö | –î—É–±–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ | –î–æ–±–∞–≤–∏—Ç—å: –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π –ø—Ä–∞–π—Å |
| 5 | unit_type –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | PIECE ‚â† WEIGHT | –î–æ–±–∞–≤–∏—Ç—å piece_weight_kg –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é |

---

# –ö–û–ù–ï–¶ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò
