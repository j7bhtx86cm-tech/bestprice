<analysis>**original_problem_statement:**
The user's primary goal is to fix systemic issues with the product matching engine and data import process.

Initial requirements (from previous session's TSD):
*   **P0.1 - Upsert on Import:** Prevent duplicate items by using an  mechanism based on a unique key.
*   **P0.2 - One Active Pricelist:** Deactivate a supplier's old items upon a new successful pricelist import.
*   **P0.3 - Import :** Correctly parse and store the minimum order quantity.
*   **P0.4 - Unit Priority:** Prioritize  from the import file over parsed units.
*   **P0.5 - BestPrice  Calculation:** Refactor the BestPrice algorithm to rank items based on .
*   **P0.6 - Safe Pricelist Deactivation:** Implement an endpoint to safely deactivate old pricelists.

A new set of critical (P0) bugs and requirements were reported by the user in the last message, based on incorrect matching results:
1.  **Fix Critical Matching Errors:** The system is making severe errors, such as matching squid fillet to chicken and mismatching attributes like shrimp with tail vs. shrimp without tail. These must be fixed with hard rules.
2.  **Adjust Similarity Thresholds:** The  matching threshold must be increased to 95%. The  threshold must be 90%.
3.  **Implement Stick with Favorite Logic:** If a cheaper alternative that meets the new thresholds is not found, the system should default to selecting the original item from the user's Favorites.
4.  **Change Default Behavior:** Favorites should have  enabled by default.

**User's preferred language**: Russian

**what currently exists?**
The agent has successfully completed a massive refactoring of the backend.
-   **P0 Import Refactor:** A new, robust importer () was created. It correctly implements  logic, deactivates old items, parses , and handles various file formats and data inconsistencies (like string-formatted prices). The data was successfully migrated.
-   **P0 BestPrice Logic:** The BestPrice algorithm in  was refactored to correctly calculate and sort by , considering . The API response was updated to include the new fields.
-   **Catalog Bug Fix:** A critical bug where the frontend catalog showed no items was diagnosed and fixed. The issue was twofold: the new importer was not populating the  and  collections used by the UI, and  values in the database were causing the API to crash. Both issues were resolved via data synchronization and data sanitization.
-   **P1 Data Quality Improvements:** Data coverage was significantly improved through backfills and new classification rules:
    -   Brand Coverage: **77.4%**
    -   High-Confidence Brands: **34.8%** (target was 20%+)
    -   Geography Coverage: **42.5%** (target was 40%+)
    -   Product Core Coverage: **95.8%**

However, the user's latest feedback revealed that despite the data quality improvements, the core matching logic itself is still critically flawed, producing unacceptable matches.

**Last working item**:
-   **Last item agent was working**: The agent was in the middle of implementing fixes for the critical matching errors reported by the user. It had analyzed the user's screenshots and feedback, identified the relevant files ( and ), and had begun adding stricter validation rules (, , and a new attribute checker) to prevent incorrect matches like squid-to-chicken.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: backend testing agent. After implementing the fixes, the agent must create specific tests that replicate the user's examples (e.g., test that Кальмар филе does NOT match КУРИЦА, and that a request for креветки с хвостом does not return креветки без хвоста). The tests must also verify the new 95%/90% thresholds and the stick with favorite logic.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Critical Matching Logic Failure (P0 - HIGHEST)**
    -   **Attempted fixes**: The agent started adding  and  to  for seafood categories. It also began creating a new function  to handle fine-grained attribute mismatches.
    -   **Next debug checklist**:
        1.  Finalize and test the rules in  to forbid cross-category matches (e.g.,  vs ).
        2.  Complete the  function to differentiate between products with/without skin, tail, etc., and integrate it into the matching pipeline in .
        3.  Create a specific test case to prove that Кальмар филе no longer matches КУРИЦА.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a critical, trust-destroying bug. Fixing it is necessary for the application to be usable.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend

-   **Issue 2: Implement New Similarity Thresholds and Stick with Favorite Logic (P0)**
    -   **Next debug checklist**:
        1.  Locate the matching logic in  (around the call to ).
        2.  Modify the code to dynamically set the  to  if  is true, and  otherwise.
        3.  After the search, check if a winner was found and if its price is actually lower than the favorite's price. If not, modify the logic to return the original favorite item as the .
        4.  In the  Pydantic model in , change the default value of  to .
    -   **Why fix this issue and what will be achieved with the fix?**: This will fulfill the user's requirement for stricter matching and prevent the system from suggesting worse deals.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: Issue 1 should be resolved first to ensure the candidates being scored are valid in the first place.

**In progress Task List**:
None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P2) **Telegram Bot Integration**: As per the original roadmap.
    -   (P2) **UI for Pricelist Management**: A user interface for suppliers to view pricelist statuses, and for admins to deactivate/delete them.

-   **Future Tasks**:
    -   (P3) Refactor the monolithic  into smaller, dedicated modules (e.g., routes, services).
    -   (P4) Advanced User Permissions.

**Completed work in this session**
-   **P0 Import & BestPrice Refactor (DONE)**: The entire data import pipeline was rebuilt with  logic,  handling, and deactivation of old items. The BestPrice algorithm was successfully updated to use . The implementation was verified with 17/17 passing automated tests.
-   **Critical Bug Fix: Empty Catalog (DONE)**: Resolved a major bug where the UI catalog was empty. This involved creating a data sync process from  to / and fixing a server crash caused by  price values.
-   **P1 Data Quality Improvement (DONE)**: Exceeded all data quality targets by adding new classification rules and backfilling data.
    -   Product Core Coverage: Reached **95.8%**.
    -   High-Confidence Brands: Reached **34.8%**.
    -   Geography Coverage: Reached **42.5%**.
-   **Bug Fix: Категория продукта не определена (DONE)**: Fixed a bug reported by the user where items like ТЕСТО were not being classified. Added new rules that increased product core coverage to over 95%.

**Earlier issues found/mentioned but not fixed**
None.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Product Matching Logic.
-   **Recurrence count**: High.
-   **Status**: IN PROGRESS. While data quality is now high, the user's latest feedback proves the core matching rules are still not strict enough, which is what the agent is currently fixing.

**Code Architecture**


**Key Technical Concepts**
-   **Data Synchronization**: The agent identified that different features used different data collections ( for BestPrice, / for Catalog) and built a sync process to resolve it.
-   **Data Sanitization**: The agent fixed a  by finding and removing  float values from the database before JSON serialization.
-   **Robust Importer**: The new  handles complex real-world data issues like varied Excel headers and non-numeric price strings.
-   **Attribute-based Matching Guards**: The agent started implementing specific checks for product attributes (e.g., with/without tail) inside  to improve matching accuracy.

**key DB schema**
-   ****: The primary source of truth for all product offers. Contains  (for upserts), , , , etc.
-   ****: A legacy collection now synced from , used by the supplier catalog UI.
-   ****: A legacy collection now synced from , used by the supplier catalog UI.

**changes in tech stack**
-   None.

**All files of reference**
-   : Contains the BestPrice logic, similarity thresholds, and API endpoints.
-   : The critical file for implementing the new matching guards (anchors, forbidden matches, attribute checks).
-   : The new, completed importer.
-   : The product requirements document.

**Areas that need refactoring**:
-    is a monolith containing business logic, API routes, and data models. It is a prime candidate for being broken down into smaller, more manageable modules.

**key api endpoints**
-   : The main endpoint for BestPrice search, which is the focus of the current bug fixes.
-   : The new, refactored endpoint for uploading pricelists.
-   : The endpoint for the supplier-facing catalog, which was recently fixed.

**Critical Info for New Agent**
-   **Your absolute highest priority (P0) is to fix the critical matching errors reported by the user in the last message.** Do not proceed to any other tasks until the system can reliably distinguish between different types of seafood and does not match seafood to meat.
-   You must implement the user's requested similarity thresholds (95% for brand-critical, 90% for non-critical) and the stick with favorite logic.
-   The default for new favorites must be .
-   The agent has already started implementing fixes in . You should continue this work. Your first step should be to review the changes made to that file and  at the end of the last session.
-   After implementing the fixes, create new, highly specific tests to prove that the reported bugs are resolved.

**documents and test reports created in this job**
-   
-   
-    (Covers the P0 import/BestPrice refactor)
-   Updated 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (PENDING)**: Reported critical matching errors (e.g., squid->chicken) and requested stricter similarity thresholds (95%/90%) and new default behaviors for favorites. **This is the current P0 task.**
2.  **Agent**: Completed all data quality improvement tasks and fixed the category not defined bug. Proposed moving to P2 tasks.
3.  **User**: Agreed to the agent's plan to run a full audit and improve brand confidence.
4.  **Agent**: Completed the P1 BestPrice UI verification and Brand Coverage tasks.
5.  **User**: Logged in and confirmed the catalog was now visible and working after the agent's fix.
6.  **Agent**: Fixed the empty catalog bug by synchronizing data to the correct collections and sanitizing  values that were crashing the server.
7.  **User**: Reported that the catalog was empty after the big import refactor.
8.  **Agent**: Finished the entire P0 import and BestPrice refactor, verified with automated tests.
9.  **User**: Approved the agent's plan to start the main P0 refactoring task.
10. **Agent**: Presented a detailed plan to implement the user's technical specification.

**Project Health Check:**
-   **Broken**: The core product matching logic is critically flawed, producing unacceptable results (e.g., matching squid to chicken) and sometimes choosing more expensive options. This breaks user trust and is the highest priority to fix.
-   **Mocked**: None.

**3rd Party Integrations**
-   , : Used for reading  files in the backend.

**Testing status**
-   **Testing agent used after significant changes**: YES. A comprehensive test suite was run and passed for the P0 import/BestPrice refactor. However, new tests are required for the current matching logic bugs.
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: 
-   **Known regressions**: The fundamental matching logic has regressed or was revealed to be flawed, leading to the current P0 bugs.

**Credentials to test flow:**
-   **Customer (Admin)**:  / 

**What agent forgot to execute**
The previous agent did not forget anything. It correctly prioritized the user's feedback and was actively working on fixing the critical matching bugs when the session ended.</analysis>
