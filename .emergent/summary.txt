<analysis>**original_problem_statement:**
The user initially wanted to overhaul the Best Price matching engine to fix systemic issues with incorrect matches, quantities, and scores. The project has since evolved into a deep, data-driven quality improvement effort.

The most recent user requests were to fix critical, absurd matching errors and implement new business rules:
1.  **Fix Absurd Matches**: The system was matching КАЛЬМАР (squid) to кура (chicken) and натуральный краб (natural crab) to крабовые палочки (crab sticks/imitation). This required a deep fix involving price analysis and stricter classification.
2.  **Country as Brand Rule**: The user has requested a new rule: if a product has a 'country' specified, the brand matching should become critical and treat the country as the required brand.
3.  **Correct Shrimp Sizing**: The system was not correctly filtering shrimp by size (e.g., 16/20, 21/25).
4.  **Flour Not Found**: A specific type of flour was not being found despite being in the catalog.
5.  ** Integration**: The user wants rules from an Excel sheet () to be strictly enforced during matching (e.g., milk fat percentage, meat grade).
6.  **Brand Criticality Logic**: The  logic was not working as intended.

**User's preferred language**: Russian

**what currently exists?**
The backend matching engine has been almost completely rewritten and is now highly sophisticated. The logic is spread across several key modules:
-   : The main FastAPI app containing the search pipeline orchestrator.
-   : Classifies items into a broad  using a combination of priority maps, guard rules (to prevent misclassification), and keyword analysis.
-   : Narrows down the  to a specific  using token-based rules.
-   : Contains multiple layers of guard logic, including required/forbidden tokens (), dynamic attribute matching for shrimp sizes,  enforcement, and a price sanity check to prevent absurdly cheap matches.
-   : Handles all unit parsing, normalization, and cost calculations. Coverage is ~95%.
-   : A script to extract and backfill  from product names. Brand coverage is now ~50% with high/medium confidence.
-   The system has undergone multiple data quality sprints, including full batch audits and backfills, significantly improving classification accuracy and reducing items in the 'other' category to just 2.2%.

**Last working item**:
-   **Last item agent was working**: The agent just finished a major debugging and feature implementation session based on the user's latest critical feedback. This involved fixing the absurd squid - - sticks matches by introducing a price sanity check and forbidden cross-match rules. It also fixed the brand criticality logic and fully integrated  into the matching pipeline.
-   **Status**: The fixes for the last set of critical bugs are COMPLETED and verified. However, the user introduced a new requirement (Country as Brand) which has not been started.
-   **Agent Testing Done**: Y
-   **Which testing method agent to use?**: Backend testing agent or manual python script to verify the new Country as Brand logic across multiple scenarios.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: **Implement Country as Brand Rule (P0)**
    -   **Description**: The user requested a new rule: если у продукта есть Страна то бренд кретичен равен стране (if a product has a Country, then brand criticality equals the country). This means if the reference item in favorites specifies a country, the search must treat that country as a  brand requirement.
    -   **Next debug checklist**:
        1.  Locate the logic in  where  is determined from the favorite item (around line 3075).
        2.  Add a condition: if  has a value, override  to  and set the  for the search to the country's name.
        3.  Create test favorites with a country specified (e.g., a product with ).
        4.  Run tests to ensure that the search correctly filters for candidates from that country only.
    -   **Why fix this issue and what will be achieved with the fix?**: This implements a new, user-requested business rule that is critical for matching items where the country of origin is more important than the commercial brand.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: None.

**In progress Task List**:
None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P1) **Brand Coverage Improvement**: Increase brand extraction coverage from ~50% to over 70% by adding more known brands and patterns to .
    -   (P2) **Full Batch Audit & Reporting**: Run a final, full batch audit on the entire ~8.2k item catalog to generate final quality reports after all recent changes.
-   **Future Tasks**:
    -   (P3) Telegram Bot Integration.
    -   (P4) Advanced User Permissions.
    -   (P5) Refactor : Decompose the monolithic file by extracting the search pipeline into a dedicated module (e.g., ) and creating separate FastAPI routers.

**Completed work in this session**
-   **P0 Critical Bug Fixes**:
    -   Fixed absurd match Кальмар - краб - палочки by creating distinct product cores ( vs ), adding forbidden cross-match rules, and implementing a price sanity check in .
    -   Fixed incorrect shrimp size matching by implementing dynamic anchor extraction in .
    -   Fixed Мука (flour) not being found by adding rules to .
-   **P1-P3 Data Quality Sprints**:
    -   **Product Core Accuracy**: Reduced items classified as other from 8.8% to **2.2%** by adding dozens of new rules to  and .
    -   **Brand Extraction**: Created  and ran backfills, increasing items with an identified brand to over **50%**.
    -   **Pack Parsing**: Improved , increasing pack data coverage from 89% to **~95%**.
    -   **Low Confidence Reduction**: Reduced items with low classification confidence from 13% to **9%**.
-   **Core Logic Implementation**:
    -   Successfully loaded and integrated  from Excel to enforce strict attribute matching (fat %, grade, etc.) via .
    -   Corrected the  logic to ensure it was properly enforced.
    -   Fixed initial bug where  was not being loaded for candidate items.

**Earlier issues found/mentioned but not fixed**
None. All major issues identified in this or previous forks have been addressed.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Product Matching Logic.
-   **Recurrence count**: High.
-   **Status**: RESOLVED. The core architectural flaws have been fixed, and multiple layers of data-driven rules, guards, and sanity checks have been added, making the system far more robust. The focus is now on new features and incremental data quality.

**Code Architecture**


**Key Technical Concepts**
-   **Layered Classification**:  ->  ->  -> .
-   **Hard Guards & Gates**: The pipeline is no longer soft. It uses multiple hard rejection points:
    -   : Wrong product core.
    -   : Incompatible units (e.g., kg vs. ml).
    -   : Missing essential keywords (e.g., кальмар for squid).
    -   : Prevents natural crab from matching crab sticks.
    -   : Enforces specific attributes like fat content, meat grade, or size.
    -   : Rejects candidates that are abnormally cheaper than the category average.
-   **Brand Logic**:  can be  (exact brand match required) or  (brand is used for scoring but not required).

**key DB schema**
-   ****: Enriched with , , .
-   ****: New collection to store rules loaded from Excel.

**changes in tech stack**
-   None.

**All files of reference**
-   : The main search pipeline logic.
-   : Critical for all guard logic.
-   : Key for initial classification.
-   : Key for specific classification.
-   : All unit/pack/cost calculations.
-   : For brand-related tasks.
-   : The source of rules for .

**Areas that need refactoring**:
-   The monolithic  file should be broken down. This is a future task.

**key api endpoints**
-   : The main endpoint for the best price search.
-   : A diagnostic endpoint to check build information.

**Critical Info for New Agent**
-   Your immediate task is to implement the **Country as Brand** rule as described in the pending issues.
-   The matching logic is now a multi-layered pipeline with several guard functions in . Debugging a match failure requires checking the logs to see which guard rejected the candidates (e.g., , , ).
-   Do not be surprised if the  collection is empty. The previous agent had to recreate test data multiple times. Be prepared to create your own test data in the  collection to verify functionality.

**documents and test reports created in this job**
-   
-   Multiple audit reports in  (e.g., ).

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (pending)**: Analyze these errors deeply and fix everything related to them. Country should equal Brand if present. Fix squid -> chicken and natural crab -> imitation crab using price analysis. (Status: Partially complete. Critical bugs fixed, Country-as-Brand rule is next).
2.  **Agent**: Acknowledged the request and began analysis.
3.  **User**: Confirmed brand logic:  must find the exact brand,  finds the cheapest option.  must be strictly enforced.
4.  **Agent**: Presented final results of the full analysis and fixes for brand/seed_dict logic.
5.  **User**: Reported critical bugs: shrimp size matching is broken, and flour is not found. Demanded to know how well  are understood.
6.  **Agent**: Confirmed all quality targets were met and presented a summary.
7.  **Agent**: Completed P3 tasks (pack parsing, low confidence reduction) and presented summary.
8.  **Agent**: Completed P2 tasks (brand extraction, 'other' reduction) and presented summary.
9.  **User**: Confirmed the plan to proceed with P1 (Full Batch Audit).
10. **Agent**: Finished the initial smoke test and root cause analysis, proposing a plan to fix the top 3 data quality issues.

**Project Health Check:**
-   **Broken**: None. The system is stable and the logic is significantly more robust than before.
-   **Mocked**: None.

**3rd Party Integrations**
-   , : Used in the backend for reading the master  file and creating  audit reports.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**:
    -    (serves as a testing/backfill script)
    -   Extensive use of temporary test scripts and direct database queries for verification.
-   **Known regressions**: None. All identified regressions were fixed.

**Credentials to test flow:**
-   **Customer (Admin)**:  / 

**What agent forgot to execute**
-   The Country as Brand rule is the only part of the last user request that has not been implemented yet. It is the highest priority for the next agent.</analysis>
