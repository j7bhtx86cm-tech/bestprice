# Best Price Matching Engine - PRD

## Описание продукта
E-commerce платформа для B2B заказов с оптимизацией многопоставочных закупок.

## Выполненные задачи

### ✅ Phase 15 - Новый движок сопоставления v2.0 (22 января 2026)

**Задача (P0)**: Полностью переработать логику "Сравнить предложения" по детальному ТЗ заказчика.

**Проблемы которые решали:**
1. В альтернативы попадают несопоставимые по формату товары (перец 0.3г → кг)
2. Мусор из других product_core (пакеты → лён семена)
3. Не соблюдаются строгие размеры (крышки, контейнеры)
4. Разные вкусы/типы мешаются в одном списке (клубника ≠ манго)
5. Молочка мешается (сгущёнка ≠ молоко, растительное ≠ обычное)
6. Мясо/рыба/полуфабрикаты мешаются (сосиски ≠ филе курицы, гёдза ≠ сырая креветка)
7. Нет приоритета бренда

**Реализовано в `/app/backend/bestprice_v12/matching_rules_v2.py`:**

1. **Кандидаты** — ТОЛЬКО из того же `product_core_id`, `active=true`, `price>0`

2. **Hard-block фильтры:**
   - **Упаковка/масштаб**: ±20% обычная еда, ±10% специи, 0% крышки
   - **Одноразка**: тип совпадает (крышка ≠ стакан), крышки строго 1:1 по размеру
   - **Вкус**: если у source есть — другой запрещён
   - **Молоко (milk_type)**: condensed ≠ dairy ≠ plant ≠ lactose_free ≠ coconut ≠ substitute
   - **Овощи**: очищенная запрещена если source не очищенная
   - **Креветки**: вид/калибр/состояние строго
   - **Тип продукта**: сосиски ≠ сырое мясо, полуфабрикаты ≠ сырьё

3. **Ранжирование:**
   1. Точные по атрибутам (size/flavor/etc)
   2. Тот же бренд
   3. Ближайшие по фасовке
   4. По цене

4. **Особенности:**
   - Контейнеры: первые 4 обязаны быть точного размера
   - Коробки vs штуки: не смешиваются

**Регрессионные тесты (все 15 из 15 прошли):**
- ✅ Перец 0.3г → НЕ показывать кг
- ✅ Стакан → только стаканы
- ✅ Крышки → только точный размер
- ✅ Вилка → только вилки
- ✅ Сахар порционный → НЕ песок
- ✅ Контейнеры → контейнеры
- ✅ Heinz → приоритет бренда
- ✅ Пакеты → НЕ семена/лён
- ✅ Трубочка со сгущёнкой → только десерты
- ✅ Сосиски → НЕ филе курицы
- ✅ Сгущёнка → НЕ обычное молоко
- ✅ Молоко кокосовое → НЕ обычное
- ✅ Огурцы → только огурцы
- ✅ Гедза с креветкой → НЕ сырые креветки
- ✅ Креветки 31/40 → НЕ другой калибр

**Файлы:**
- `/app/backend/bestprice_v12/matching_rules_v2.py` — новый движок (v2.0)
- `/app/backend/bestprice_v12/routes.py` — обновлён endpoint

---

### ✅ Phase 14 - Lexicon-based Matching Rules v1.3 (21 января 2026)

**Задача (P0)**: Исправить "Сравнить предложения" — нелогичные альтернативы (сосиски → курица).

**Реализовано:**
- Подключен словарь `lexicon_ru_v1_3.json`
- Модуль `matching_rules.py` с HB1-HB5 и Negative Blocks
- Tier System (A/B/C)

---

## Архитектура

```
/app/backend/bestprice_v12/
├── matching_rules_v2.py    # Новый движок сопоставления (v2.0)
├── matching_rules.py       # Старый lexicon-based (v1.3)
├── routes.py               # API endpoints (использует v2.0)
└── lexicon_ru_v1_3.json    # Словарь для v1.3

/app/frontend/src/
└── pages/customer/
    └── CustomerCatalog.js  # Каталог с поиском и "Сравнить предложения"
```

## API Endpoints

### GET /api/v12/item/{item_id}/alternatives
Возвращает альтернативные офферы для товара.

**Query params:**
- `limit` (int, default 10, max 20)

**Response:**
```json
{
  "source": {
    "id": "...",
    "name": "...",
    "price": 160,
    "product_core_id": "meat.sausage",
    "signature": {
      "flavor": null,
      "milk_type": null,
      "disposable_type": null,
      ...
    }
  },
  "alternatives": [
    {
      "id": "...",
      "name": "...",
      "price": 128.94,
      "match_score": 150,
      "match_badges": ["SAME_BRAND", "EXACT_SIZE"],
      "exact_size": true,
      "same_brand": true
    }
  ],
  "total": 10,
  "rejected_reasons": {
    "PACK_MISMATCH": 25,
    "TYPE_EXCLUSION": 5
  }
}
```

## Тестовые аккаунты
- Customer: `customer@bestprice.ru` / `password123`

## Предстоящие задачи

### P1 - Рефакторинг routes.py
- Перенос endpoints в `/routes_modules/` (catalog, suppliers, etc.)

### P3 - Будущие улучшения
- Интеграция auto_classifier.py в импорт прайс-листов
- Telegram-бот для уведомлений
- UI для отладки решений matching
- A/B тестирование поиска
